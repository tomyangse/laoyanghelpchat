<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老杨帮你聊 - 智能信息回复助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+SC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* * 设计理念: 北欧极简风格 (Nordic Minimalist)
         * 1. 色彩: 采用低饱和度的中性色调，营造宁静、专业的氛围。主色调为深灰蓝，辅以不同层次的灰色。
         * 2. 字体: Inter (英文) 和 Noto Sans SC (中文) 提供了极佳的现代感和可读性。
         * 3. 布局: 增加元素间距 (Whitespace)，创造呼吸感，让视觉焦点更清晰。
         * 4. 组件: 按钮、输入框等元素采用更柔和的圆角和细致的边框，提升精致感。
        */
        body {
            font-family: 'Inter', 'Noto Sans SC', sans-serif;
            background-color: #f4f7f9; /* 柔和的浅灰色背景 */
        }
        .card {
            background-color: #ffffff;
            border: 1px solid #e5e7eb; /* 细致的边框 */
        }
        .btn-primary {
            background-color: #2c3e50; /* 深灰蓝主色调 */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
        }
        .btn-primary:hover {
            background-color: #34495e;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .btn-tone {
            background-color: #ffffff;
            color: #4b5563;
            border: 1px solid #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .btn-tone:hover {
            border-color: #2c3e50;
            color: #2c3e50;
        }
        .btn-tone.active {
            background-color: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="card rounded-2xl shadow-xl p-8 md:p-10 space-y-8">
            
            <!-- Header -->
            <div class="flex justify-center items-center gap-4 sm:gap-6">
                <img src="https://raw.githubusercontent.com/tomyangse/laoyanghelpchat/main/laoyang.jpeg" alt="老杨卡通形象" class="h-20 w-20 rounded-full object-cover border-2 border-white shadow-md">
                <div class="text-left">
                    <h1 class="text-4xl font-bold text-gray-800">老杨帮你聊</h1>
                    <p class="text-gray-500 mt-1 text-lg">上传对话截图，轻松回复每一条信息</p>
                </div>
            </div>

            <!-- Step 1: Image Upload -->
            <div id="step1">
                <div class="space-y-2 mb-4">
                    <p class="text-sm font-semibold text-gray-500 tracking-wide uppercase">第一步</p>
                    <h2 class="text-xl font-semibold text-gray-800">上传对话截图</h2>
                </div>
                <div class="border-2 border-dashed border-gray-300 rounded-xl p-8 text-center cursor-pointer hover:border-gray-400 transition" id="dropzone">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <div id="upload-prompt">
                        <svg class="mx-auto h-12 w-12 text-gray-300" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z" />
                        </svg>
                        <p class="mt-4 text-sm text-gray-600">点击此处选择图片，或将图片拖拽到这里</p>
                        <p class="text-xs text-gray-400 mt-1">支持 PNG, JPG, GIF 等格式</p>
                    </div>
                    <img id="imagePreview" src="" alt="Image Preview" class="hidden max-h-48 mx-auto rounded-lg shadow-md"/>
                </div>
                <button id="analyzeBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-6 text-base" disabled>
                    老杨马上翻译给您
                </button>
            </div>

            <!-- Loading Spinner -->
            <div id="loader" class="hidden text-center py-12">
                <div role="status" class="flex flex-col items-center">
                    <svg aria-hidden="true" class="w-12 h-12 text-gray-300 animate-spin fill-[#2c3e50]" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367tes41 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                    </svg>
                    <p class="mt-4 text-gray-500">AI 正在努力分析，请稍候...</p>
                </div>
            </div>

            <!-- Step 2: Analysis Result -->
            <div id="step2" class="hidden space-y-8">
                 <div class="space-y-2">
                    <p class="text-sm font-semibold text-gray-500 tracking-wide uppercase">第二步</p>
                    <h2 class="text-xl font-semibold text-gray-800">确认信息并准备回复</h2>
                </div>
                <div class="space-y-4 p-5 bg-gray-50 rounded-lg border border-gray-200">
                    <div class="flex items-start">
                        <strong class="text-gray-500 w-24 shrink-0">识别语言：</strong> <span id="language" class="font-semibold text-gray-800"></span>
                    </div>
                     <div class="flex items-start">
                        <strong class="text-gray-500 w-24 shrink-0">原文内容：</strong> <span id="originalText" class="text-gray-700"></span>
                    </div>
                     <div class="flex items-start">
                        <strong class="text-gray-500 w-24 shrink-0">中文意思：</strong> <span id="translatedText" class="text-gray-800 font-semibold"></span>
                    </div>
                </div>

                <div class="space-y-4">
                    <div>
                        <label for="replyIntent" class="block font-medium text-gray-700 mb-2">您想回复的内容（用中文输入）：</label>
                        <textarea id="replyIntent" rows="3" class="w-full border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-[#2c3e50] focus:border-[#2c3e50] transition" placeholder="例如：好啊，下午2点可以吗？"></textarea>
                    </div>
                    <div>
                        <label class="block font-medium text-gray-700 mb-2">选择回复语气：</label>
                        <div class="flex flex-wrap gap-3" id="tone-options">
                            <button class="btn-tone px-4 py-2 rounded-lg text-sm" data-tone="casual">朋友般随意</button>
                            <button class="btn-tone px-4 py-2 rounded-lg text-sm" data-tone="friendly">友好标准</button>
                            <button class="btn-tone px-4 py-2 rounded-lg text-sm" data-tone="polite">礼貌客气</button>
                            <button class="btn-tone px-4 py-2 rounded-lg text-sm" data-tone="business">商务正式</button>
                        </div>
                    </div>
                </div>
                 <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg text-base">
                    生成回复
                </button>
            </div>

            <!-- Step 3: Generated Reply -->
            <div id="step3" class="hidden space-y-6">
                <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 text-green-500 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    生成成功！这是为您准备的回复
                </h2>
                <div class="p-5 bg-gray-50 rounded-lg relative border border-gray-200">
                    <div class="space-y-3">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">回复的中文意思：</p>
                            <p id="replyTranslationDisplay" class="text-gray-700"></p>
                        </div>
                        <hr class="border-gray-200">
                        <div>
                            <p class="text-sm text-gray-500 mb-1">最终回复：</p>
                            <p id="finalReply" class="text-gray-900 text-lg font-semibold"></p>
                        </div>
                    </div>
                    <button id="copyBtn" class="absolute top-4 right-4 btn-secondary px-3 py-1 text-sm rounded-md">复制</button>
                </div>
                <button id="resetBtn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg text-base">
                    开始新的对话
                </button>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden p-4 bg-red-50 text-red-700 rounded-lg border border-red-200"></div>

        </div>
    </div>

    <script>
        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        
        const dropzone = document.getElementById('dropzone');
        const imageUpload = document.getElementById('imageUpload');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        const languageEl = document.getElementById('language');
        const originalTextEl = document.getElementById('originalText');
        const translatedTextEl = document.getElementById('translatedText');
        
        const replyIntentEl = document.getElementById('replyIntent');
        const toneOptions = document.getElementById('tone-options');
        const generateBtn = document.getElementById('generateBtn');
        
        const finalReplyEl = document.getElementById('finalReply');
        const replyTranslationDisplayEl = document.getElementById('replyTranslationDisplay');
        const copyBtn = document.getElementById('copyBtn');
        const resetBtn = document.getElementById('resetBtn');

        // App State
        let imageData = null;
        let analysisResult = {};
        let selectedTone = '';

        // Event Listeners
        dropzone.addEventListener('click', () => imageUpload.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-gray-400', 'bg-gray-50');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-gray-400', 'bg-gray-50');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-gray-400', 'bg-gray-50');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        analyzeBtn.addEventListener('click', handleAnalyze);
        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', handleCopy);
        resetBtn.addEventListener('click', resetApp);
        
        toneOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.btn-tone').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                selectedTone = e.target.dataset.tone;
            }
        });

        // Functions
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('请上传图片文件。');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                analyzeBtn.disabled = false;
                imageData = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        async function handleAnalyze() {
            if (!imageData) {
                showError('请先选择一张图片。');
                return;
            }
            setLoading(true);
            step1.classList.add('hidden');

            try {
                const response = await fetch('/api/analyzeImage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '分析图片时发生未知错误。');
                }

                const data = await response.json();
                analysisResult = data;
                
                languageEl.textContent = data.language || '未能识别';
                originalTextEl.textContent = data.originalText || '未能识别';
                translatedTextEl.textContent = data.translatedText || '未能翻译';

                step2.classList.remove('hidden');
            } catch (err) {
                showError(err.message);
                step1.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        async function handleGenerate() {
            const userIntent = replyIntentEl.value.trim();
            if (!userIntent) {
                showError('请输入您想回复的内容。');
                return;
            }
            if (!selectedTone) {
                showError('请选择一个回复语气。');
                return;
            }
            
            setLoading(true);
            step2.classList.add('hidden');
            
            try {
                const response = await fetch('/api/generateReply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        originalText: analysisResult.originalText,
                        language: analysisResult.language,
                        userIntent: userIntent,
                        tone: selectedTone
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '生成回复时发生未知错误。');
                }

                const data = await response.json();
                finalReplyEl.textContent = data.reply;
                replyTranslationDisplayEl.textContent = data.replyTranslation;
                step3.classList.remove('hidden');

            } catch(err) {
                showError(err.message);
                step2.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        function handleCopy() {
            navigator.clipboard.writeText(finalReplyEl.textContent)
                .then(() => {
                    copyBtn.textContent = '已复制!';
                    setTimeout(() => { copyBtn.textContent = '复制'; }, 2000);
                })
                .catch(err => {
                    showError('复制失败: ' + err);
                });
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function resetApp() {
            imageData = null;
            analysisResult = {};
            selectedTone = '';

            imageUpload.value = '';
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            uploadPrompt.classList.remove('hidden');
            analyzeBtn.disabled = true;

            replyIntentEl.value = '';
            document.querySelectorAll('.btn-tone').forEach(btn => btn.classList.remove('active'));
            replyTranslationDisplayEl.textContent = ''; 

            step1.classList.remove('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');
            loader.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>

