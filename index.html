<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>老杨帮你聊 - 智能信息回复助手</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Helvetica Neue', 'Arial', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
            transition: background-color 0.3s ease;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .btn-secondary {
            background-color: #e5e7eb;
            color: #1f2937;
            transition: background-color 0.3s ease;
        }
        .btn-secondary:hover {
            background-color: #d1d5db;
        }
        .btn-tone.active {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-2xl mx-auto">
        <div class="card rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
            
            <!-- Header -->
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">老杨帮你聊 💬</h1>
                <p class="text-gray-600 mt-2">上传对话截图，轻松回复每一条信息</p>
            </div>

            <!-- Step 1: Image Upload -->
            <div id="step1">
                <h2 class="text-lg font-semibold text-gray-700 mb-3">第一步：上传对话截图</h2>
                <div class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:border-indigo-500 transition" id="dropzone">
                    <input type="file" id="imageUpload" class="hidden" accept="image/*">
                    <div id="upload-prompt">
                        <svg class="mx-auto h-12 w-12 text-gray-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true">
                            <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <p class="mt-2 text-sm text-gray-600">点击此处选择图片，或将图片拖拽到这里</p>
                    </div>
                    <img id="imagePreview" src="" alt="Image Preview" class="hidden max-h-48 mx-auto rounded-lg"/>
                </div>
                <button id="analyzeBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg mt-4 disabled:bg-gray-400" disabled>
                    分析图片内容
                </button>
            </div>

            <!-- Loading Spinner -->
            <div id="loader" class="hidden text-center py-8">
                <div role="status">
                    <svg aria-hidden="true" class="inline w-10 h-10 text-gray-200 animate-spin dark:text-gray-600 fill-indigo-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentFill"/>
                    </svg>
                    <p class="mt-4 text-gray-600">AI 正在努力分析，请稍候...</p>
                </div>
            </div>

            <!-- Step 2: Analysis Result -->
            <div id="step2" class="hidden space-y-4">
                <h2 class="text-lg font-semibold text-gray-700">第二步：确认信息与准备回复</h2>
                <div class="space-y-3 p-4 bg-gray-50 rounded-lg">
                    <p><strong><span class="text-indigo-600">识别语言：</span></strong> <span id="language"></span></p>
                    <p><strong><span class="text-indigo-600">原文内容：</span></strong> <span id="originalText" class="text-gray-700"></span></p>
                    <p><strong><span class="text-indigo-600">中文意思：</span></strong> <span id="translatedText" class="text-gray-700 font-semibold"></span></p>
                </div>

                <div class="space-y-3">
                    <label for="replyIntent" class="font-semibold text-gray-700">您想回复的内容（用中文输入）：</label>
                    <textarea id="replyIntent" rows="3" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="例如：好啊，下午2点可以吗？"></textarea>
                    
                    <label class="font-semibold text-gray-700">选择回复语气：</label>
                    <div class="flex flex-wrap gap-2" id="tone-options">
                        <button class="btn-tone border border-gray-300 px-4 py-2 rounded-lg text-sm" data-tone="casual">朋友般随意</button>
                        <button class="btn-tone border border-gray-300 px-4 py-2 rounded-lg text-sm" data-tone="friendly">友好标准</button>
                        <button class="btn-tone border border-gray-300 px-4 py-2 rounded-lg text-sm" data-tone="polite">礼貌客气</button>
                        <button class="btn-tone border border-gray-300 px-4 py-2 rounded-lg text-sm" data-tone="business">商务正式</button>
                    </div>
                </div>
                 <button id="generateBtn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg disabled:bg-gray-400">
                    生成回复
                </button>
            </div>

            <!-- Step 3: Generated Reply -->
            <div id="step3" class="hidden space-y-4">
                <h2 class="text-lg font-semibold text-green-700">生成成功！这是为您准备的回复：</h2>
                <div class="p-4 bg-green-50 rounded-lg relative">
                    <p id="finalReply" class="text-gray-800 text-lg"></p>
                    <button id="copyBtn" class="absolute top-2 right-2 btn-secondary px-3 py-1 text-sm rounded-md">复制</button>
                </div>
                <button id="resetBtn" class="w-full btn-secondary font-bold py-3 px-4 rounded-lg">
                    开始新的对话
                </button>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden p-4 bg-red-100 text-red-700 rounded-lg"></div>

        </div>
    </div>

    <script>
        // DOM Elements
        const step1 = document.getElementById('step1');
        const step2 = document.getElementById('step2');
        const step3 = document.getElementById('step3');
        const loader = document.getElementById('loader');
        const errorMessage = document.getElementById('error-message');
        
        const dropzone = document.getElementById('dropzone');
        const imageUpload = document.getElementById('imageUpload');
        const uploadPrompt = document.getElementById('upload-prompt');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        const languageEl = document.getElementById('language');
        const originalTextEl = document.getElementById('originalText');
        const translatedTextEl = document.getElementById('translatedText');
        
        const replyIntentEl = document.getElementById('replyIntent');
        const toneOptions = document.getElementById('tone-options');
        const generateBtn = document.getElementById('generateBtn');
        
        const finalReplyEl = document.getElementById('finalReply');
        const copyBtn = document.getElementById('copyBtn');
        const resetBtn = document.getElementById('resetBtn');

        // App State
        let imageData = null;
        let analysisResult = {};
        let selectedTone = '';

        // Event Listeners
        dropzone.addEventListener('click', () => imageUpload.click());
        dropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropzone.classList.add('border-indigo-500');
        });
        dropzone.addEventListener('dragleave', () => {
            dropzone.classList.remove('border-indigo-500');
        });
        dropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropzone.classList.remove('border-indigo-500');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });
        imageUpload.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        analyzeBtn.addEventListener('click', handleAnalyze);
        generateBtn.addEventListener('click', handleGenerate);
        copyBtn.addEventListener('click', handleCopy);
        resetBtn.addEventListener('click', resetApp);
        
        toneOptions.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                document.querySelectorAll('.btn-tone').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                selectedTone = e.target.dataset.tone;
            }
        });

        // Functions
        function handleFile(file) {
            if (!file.type.startsWith('image/')) {
                showError('请上传图片文件。');
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                imagePreview.src = e.target.result;
                imagePreview.classList.remove('hidden');
                uploadPrompt.classList.add('hidden');
                analyzeBtn.disabled = false;
                // Store base64 data without the prefix
                imageData = e.target.result.split(',')[1];
            };
            reader.readAsDataURL(file);
        }

        async function handleAnalyze() {
            if (!imageData) {
                showError('请先选择一张图片。');
                return;
            }
            setLoading(true);
            step1.classList.add('hidden');

            try {
                const response = await fetch('/api/analyzeImage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '分析图片时发生未知错误。');
                }

                const data = await response.json();
                analysisResult = data;
                
                languageEl.textContent = data.language || '未能识别';
                originalTextEl.textContent = data.originalText || '未能识别';
                translatedTextEl.textContent = data.translatedText || '未能翻译';

                step2.classList.remove('hidden');
            } catch (err) {
                showError(err.message);
                step1.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        async function handleGenerate() {
            const userIntent = replyIntentEl.value.trim();
            if (!userIntent) {
                showError('请输入您想回复的内容。');
                return;
            }
            if (!selectedTone) {
                showError('请选择一个回复语气。');
                return;
            }
            
            setLoading(true);
            step2.classList.add('hidden');
            
            try {
                const response = await fetch('/api/generateReply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        originalText: analysisResult.originalText,
                        language: analysisResult.language,
                        userIntent: userIntent,
                        tone: selectedTone
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || '生成回复时发生未知错误。');
                }

                const data = await response.json();
                finalReplyEl.textContent = data.reply;
                step3.classList.remove('hidden');

            } catch(err) {
                showError(err.message);
                step2.classList.remove('hidden');
            } finally {
                setLoading(false);
            }
        }
        
        function handleCopy() {
            navigator.clipboard.writeText(finalReplyEl.textContent)
                .then(() => {
                    copyBtn.textContent = '已复制!';
                    setTimeout(() => { copyBtn.textContent = '复制'; }, 2000);
                })
                .catch(err => {
                    showError('复制失败: ' + err);
                });
        }

        function setLoading(isLoading) {
            if (isLoading) {
                loader.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            } else {
                loader.classList.add('hidden');
            }
        }

        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function resetApp() {
            // Reset state
            imageData = null;
            analysisResult = {};
            selectedTone = '';

            // Reset UI
            imageUpload.value = ''; // Clear file input
            imagePreview.classList.add('hidden');
            imagePreview.src = '';
            uploadPrompt.classList.remove('hidden');
            analyzeBtn.disabled = true;

            replyIntentEl.value = '';
            document.querySelectorAll('.btn-tone').forEach(btn => btn.classList.remove('active'));

            step1.classList.remove('hidden');
            step2.classList.add('hidden');
            step3.classList.add('hidden');
            loader.classList.add('hidden');
            errorMessage.classList.add('hidden');
        }
    </script>
</body>
</html>
